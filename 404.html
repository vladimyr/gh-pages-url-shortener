<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Redirecting...</title>
    <!-- Configuration goes here -->
    <script id="config" type="application/json">
      {
        "githubRepo": "nelsontky/gh-pages-url-shortener-db",
        "publicPath": "/",
        "schemeAllowlist": [
          "https:",
          "http:",
          "ftp:"
        ]
      }
    </script>
  </head>
  <body>
    <div id="errorMessage" style="display: none">
      <p>Short URL is invalid! (Or you have been spamming the site too much)</p>
      <p>
        <a href="https://github.com/nelsontky/gh-pages-url-shortener">
          Learn more about this URL shortener'
        </a>
      </p>
    </div>
    <script>
      (function () {
        var $config = document.getElementById('config');
        var $errorMessage = document.getElementById('errorMessage');

        var config = JSON.parse($config.textContent);
        var GITHUB_API_URL = 'https://api.github.com';

        (function redirect() {
          var publicPath = normalize(config.publicPath);
          var pathname = location.pathname.replace(publicPath, '');

          Promise.resolve(pathname.match(/^\/?([^/]+)/))
            .then(function (match) {
              var issue = match && parseInt(match[1], 10);
              if (issue) {
                return fetchIssue(issue);
              }
              throw new Error('Invalid issue number');
            })
            .then(function (payload) {
              var url = parseUrl(payload.title);
              if (url && isAllowed(url)) {
                return location.replace(url);
              }
              throw new Error('Invalid redirect URL');
            })
            .catch(function (error) {
              var title = 'Invalid URL!';
              history.replaceState(null, title, publicPath);
              document.title = title;
              $errorMessage.style.display = 'initial';
              console.error(error);
            });
        }());

        function isAllowed(url) {
          if (url.hostname === location.hostname) {
            return false;
          }
          return config.schemeAllowlist.indexOf(url.protocol) !== -1;
        }

        function fetchIssue(issue) {
          var pathname = ['repos', config.githubRepo, 'issues', issue].join('/');
          var issueUrl = new URL(pathname, GITHUB_API_URL);

          return fetch(issueUrl).then(function (response) {
            if (response.status === 200) {
              return response.json();
            }
            var error = new Error(response.statusText);
            error.response = response;
            throw error;
          });
        }

        function normalize(path) {
          path = path || '/';
          return path
            .replace(/\/+/g, '/')
            .replace(/^\/?/, '/');
        }

        function parseUrl(url) {
          try {
            return new URL(url);
          } catch (err) {
            return null;
          }
        }
      }());
    </script>
  </body>
</html>

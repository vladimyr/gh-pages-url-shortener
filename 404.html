<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Redirecting...</title>
  </head>
  <body>
    <script>
      (function () {
        /**
         * Configuration goes here
         */
        var GITHUB_REPO = 'nelsontky/gh-pages-url-shortener-db';
        var GITHUB_API_URL = 'https://api.github.com';

        /**
         * DO NOT TOUCH ANYTHING BELOW THIS COMMENT UNLESS YOU KNOW WHAT YOU ARE DOING
         */
        (function redirect() {
          var home;
          var issue;

          var match = location.pathname.match(/^\/([^/]+)(?:\/([^/]+))?/);

          if (/\.github\.io$/.test(location.hostname)) {
            home = match[1];
            issue = match[2];
          } else {
            home = '';
            issue = match[1];
          }

          fetchIssue(issue)
            .then(function (payload) {
              var url = parseUrl(payload.title);
              if (url && isAllowed(url)) {
                return location.replace(url);
              }
              throw new Error('URL to redirect to is invalid!');
            })
            .catch(function () {
              var homepage = new URL(home, location.origin);
              location.replace(homepage);
            });
        }());

        function isAllowed(url) {
          if (url.host === location.host) {
            return false;
          }
          return url.protocol === 'https:' || url.protocol === 'http:';
        }

        function fetchIssue(issue) {
          var pathname = ['repos', GITHUB_REPO, 'issues', issue].join('/');
          var issueUrl = new URL(pathname, GITHUB_API_URL);

          return fetch(issueUrl).then(function (response) {
            if (response.status === 200) {
              return response.json();
            }
            throw new Error(
              "An error occurred with the GitHub API. Maybe you've exceeded your API limits (60 per hour)"
            );
          });
        }

        function parseUrl(url) {
          try {
            return new URL(url);
          } catch (err) {
            return null;
          }
        }
      }());
    </script>
  </body>
</html>

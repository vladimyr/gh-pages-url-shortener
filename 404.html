<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Redirecting...</title>
  </head>
  <body>
    <div id="errorMessage" style="display: none">
      <p>Short URL is invalid! (Or you have been spamming the site too much)</p>
      <p>
        <a href="https://github.com/nelsontky/gh-pages-url-shortener">
          Learn more about this URL shortener'
        </a>
      </p>
    </div>
    <script>
      (function () {
        /**
         * Configuration goes here
         */
        var GITHUB_REPO = 'nelsontky/gh-pages-url-shortener-db';
        var PUBLIC_PATH = '/';

        /**
         * DO NOT TOUCH ANYTHING BELOW THIS COMMENT UNLESS YOU KNOW WHAT YOU ARE DOING
         */
        var GITHUB_API_URL = 'https://api.github.com';

        (function redirect() {
          var publicPath = normalize(PUBLIC_PATH);
          var pathname = location.pathname.replace(publicPath, '');

          Promise.resolve(pathname.match(/^\/?([^/]+)/))
            .then(function (match) {
              var issue = match && parseInt(match[1], 10);
              if (!isNaN(issue)) {
                return fetchIssue(issue);
              }
              throw new Error('Invalid issue number');
            })
            .then(function (payload) {
              var url = parseUrl(payload.title);
              if (url && isAllowed(url)) {
                return location.replace(url);
              }
              throw new Error('Invalid redirect URL');
            })
            .catch(function () {
              var title = 'Invalid URL!';
              history.replaceState(null, title, publicPath);
              document.title = title;
              document.errorMessage.style.display = 'initial';
            });
        }());

        function isAllowed(url) {
          if (url.hostname === location.hostname) {
            return false;
          }
          return url.protocol === 'https:' || url.protocol === 'http:';
        }

        function fetchIssue(issue) {
          var pathname = ['repos', GITHUB_REPO, 'issues', issue].join('/');
          var issueUrl = new URL(pathname, GITHUB_API_URL);

          return fetch(issueUrl).then(function (response) {
            if (response.status === 200) {
              return response.json();
            }
            var error = new Error(response.statusText);
            error.response = response;
            throw error;
          });
        }

        function normalize(path) {
          path = path || '/';
          return path
            .replace(/\/+/g, '/')
            .replace(/^\/?/, '/');
        }

        function parseUrl(url) {
          try {
            return new URL(url);
          } catch (err) {
            return null;
          }
        }
      }());
    </script>
  </body>
</html>
